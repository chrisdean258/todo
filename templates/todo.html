
<HTML>
  <head>
    <title>Todo</title>
    <style>
      .todo-container{
        position: relative;
        left: 30px;
      }
      .todo-add{
        position: relative;
        left: 15px;
      }
      button {
        background-color: #555555;
        border: none;
        color: white;
        /*padding: 15px 32px;*/
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
      }

    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>

function togglecontainer(node, just_show=false) {
  var containernode = node.children("#" + node.attr("id") + "-container");
  var btn = node.children("#" + node.attr("id") + "-toggle");
  if (containernode.css("display") == "none" || just_show) {
    containernode.css("display", "block");
    btn.html("&uarr;")
  }
  else {
    containernode.css("display", "none");
    btn.html("&equiv;")
  }
}

function toggleaddform(node) {
  var formnode = node.find("#" + node.attr("id") + "-formdiv");
  var btn = node.find("#" + node.attr("id") + "-add");
  if (formnode.css("display") == "none") {
    formnode.css("display", "block");
    togglecontainer(node, true);
    btn.html("&minus;")
  }
  else {
    formnode.css("display", "none");
    btn.html("&plus;")
  }
}

function add_todo(pnode) {
  parentid = pnode.attr("id");
  node = pnode.find("#" + parentid + "-newtitle")

  data = {
    "parent": parentid,
    "title": node.val()
  }

  $.post("/todo", data, function (data) {
    resp = data;
    newtodo = JSON.parse(data);
    render_todo(newtodo, pnode);
    node.val("");
  });
}

function del_todo(node) {
  nodeid = node.attr("id");
  $.ajax({
         url: "/todo/" + nodeid,
         type: "DELETE",
         success: function(result) {
           pnode.remove();
         }
  })
}

function update_todo(node) {
  nodeid = node.attr("id");
  $.post("/todo/" + nodeid, { newtitle: $("#" + nodeid + "-title").text() })
}


function render_todo(todo, pnode) {
  var todonode = pnode.find("#" + pnode.attr("id") + "-list");
  var newnode = $("<div>").attr("id", todo.id)

  var delbtn = $("<button>").attr("id", todo.id + "-delete").addClass("delete-button").html("&times;")
    .click(function() { del_todo(newnode); });
  var addbtn = $("<button>").attr("id", todo.id + "-add").addClass("add-button").html("&plus;")
    .click(function() { toggleaddform(newnode); });
  var expandbtn = $("<button>").attr("id", todo.id + "-toggle").addClass("toggle-button").html("&equiv;")
    .click(function() { togglecontainer(newnode) });
  newnode.append(delbtn).append(addbtn).append(expandbtn);

  var titlediv = $("<div>").attr("id", todo.id + "-title").css("display", "inline").addClass("todo-title").text(todo.title).attr("contentEditable", true);
  titlediv.focusout(function() { update_todo(newnode); });
  newnode.append(titlediv);
  var container = $("<div>").attr("id", todo.id + "-container").addClass("todo-container").css("display", "none");
  newnode.append(container);
  container.append($("<div>").attr("id", todo.id + "-list").addClass("todo-list"));
  formdiv = $("<div>").attr("id", todo.id + "-formdiv").addClass("todo-form").css("display", "none");
  var form = $("<form>").submit(function(ev) { ev.preventDefault(); add_todo(newnode); });
  formdiv.append(form)
  form.append($("<input>").attr("type", "text").attr("id", todo.id + "-newtitle"));
  form.append($("<input>").attr("type", "submit"));

  container.append(formdiv);
  todonode.append(newnode);
  return newnode;
}

function render_todos(todo, pnode) {
  var newnode = render_todo(todo, pnode);
  for(var child_todo of todo.todos) 
    render_todos(child_todo, newnode);
}

window.onload = function() {
  todos = JSON.parse('{{data.todos|tojson}}');
  var pnode = $("#todos")
  for(var todo of todos)
    render_todos(todo, pnode);
  togglecontainer(pnode, true);
}
    </script>
  </head>
  <body>
    <h1>Todo for {{data.username}}</h1>
    <div id="todos">
      <div id="todos-container" class="todo-container">
        <div id="todos-list" class="todo-list"></div>
        <div id="todos-form" class="todo-form"></div>
      </div>
    </div>
  </body>
</HTML>

